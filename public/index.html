<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤©ç¿¼äº‘æ–‡ä»¶æµè§ˆå™¨</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        h1, h2, h3 {
            text-align: center;
            color: #0066cc;
        }
        .file-explorer {
            background-color: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .captcha-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999; /* å¢åŠ z-indexå€¼ç¡®ä¿å¼¹çª—ä½äºæœ€é¡¶å±‚ */
        }
        .captcha-modal.hidden {
            display: none;
        }
        .captcha-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 100%;
        }
        .captcha-content h3 {
            margin-top: 0;
        }
        .captcha-image {
            display: block;
            margin: 15px auto;
            max-width: 100%;
            height: auto;
        }
        .captcha-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .captcha-buttons {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 15px;
        }
        .captcha-buttons button {
            flex: 1;
            padding: 10px;
        }
        button {
            background-color: #0066cc;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
        }
        button:hover {
            background-color: #0055aa;
        }
        .success {
            background-color: #e6f7e6;
            border: 1px solid #c3e6c3;
        }
        .error {
            background-color: #fce4e4;
            border: 1px solid #fcc2c2;
        }
        .warning {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
        }
        .file-list {
            list-style: none;
            padding: 0;
        }
        .file-item, .folder-item {
            padding: 10px;
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
        }
        .file-item {
            cursor: pointer;
        }
        .file-item:hover {
            background-color: #f0f0f0;
        }
        .file-icon, .folder-icon {
            margin-right: 10px;
            width: 24px;
            height: 24px;
        }
        .folder-icon {
            color: #f8d775;
        }
        .file-icon {
            color: #78a2cc;
        }
        .folder-item {
            cursor: pointer;
        }
        .folder-item:hover {
            background-color: #f0f0f0;
        }
        .download-status {
            margin-top: 5px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }
        .download-status.success {
            display: block;
            background-color: #d4edda;
            color: #155724;
        }
        .download-status.error {
            display: block;
            background-color: #f8d7da;
            color: #721c24;
        }
        .download-status.loading {
            display: block;
            background-color: #fff3cd;
            color: #856404;
        }
        .download-link {
            display: block;
            margin-top: 10px;
            color: #0066cc;
            text-decoration: underline;
        }
        .breadcrumb {
            display: flex;
            flex-wrap: wrap;
            padding: 8px 0;
            margin-bottom: 15px;
            list-style: none;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .breadcrumb-item {
            padding: 5px 10px;
            cursor: pointer;
        }
        .breadcrumb-item:hover {
            text-decoration: underline;
        }
        .breadcrumb-item + .breadcrumb-item::before {
            content: "/";
            padding: 0 5px;
            color: #6c757d;
        }
        .hidden {
            display: none;
        }
        .button-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .button-row button {
            flex: 1;
        }
        .status-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #f8f9fa;
            border-radius: 4px;
            padding: 8px 10px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        .status-bar .login-status {
            color: #28a745;
            font-weight: bold;
        }
        .status-bar button {
            width: auto;
            padding: 6px 12px;
            font-size: 14px;
        }
        .loading {
            text-align: center;
            margin: 20px 0;
            font-size: 18px;
        }
        .loading::after {
            content: "...";
            animation: dots 1.5s steps(5, end) infinite;
        }
        .debug-link {
            text-align: center;
            font-size: 12px;
            margin-top: 20px;
            opacity: 0.7;
        }
        .debug-link a {
            color: #666;
            text-decoration: none;
        }
        .debug-link a:hover {
            text-decoration: underline;
        }
        @keyframes dots {
            0%, 20% { content: ""; }
            40% { content: "."; }
            60% { content: ".."; }
            80%, 100% { content: "..."; }
        }
    </style>
</head>
<body>
    <h1>å¤©ç¿¼äº‘æ–‡ä»¶æµè§ˆå™¨</h1>
    
    <!-- éªŒè¯ç å¼¹çª— -->
    <div id="captchaModal" class="captcha-modal hidden">
        <div class="captcha-content">
            <h3>è¯·è¾“å…¥éªŒè¯ç </h3>
            <div id="captchaStatus" style="text-align: center; color: #666; margin-bottom: 10px;">éªŒè¯ç å›¾ç‰‡åŠ è½½ä¸­...</div>
            <img id="captchaImage" class="captcha-image" src="" alt="éªŒè¯ç å›¾ç‰‡" onerror="this.style.display='none';document.getElementById('captchaStatus').innerText='éªŒè¯ç å›¾ç‰‡åŠ è½½å¤±è´¥';document.getElementById('captchaStatus').style.color='red';" onload="this.style.display='block';document.getElementById('captchaStatus').style.display='none';">
            <input id="captchaInput" class="captcha-input" type="text" placeholder="è¯·è¾“å…¥å›¾ç‰‡ä¸­çš„éªŒè¯ç " maxlength="5">
            <div class="captcha-buttons">
                <button id="submitCaptchaBtn">æäº¤</button>
                <button id="cancelCaptchaBtn">å–æ¶ˆ</button>
            </div>
            <div style="margin-top: 10px; text-align: center;">
                <button id="refreshCaptchaBtn" style="font-size: 12px; padding: 5px;">åˆ·æ–°éªŒè¯ç </button>
            </div>
        </div>
    </div>
    
    <div id="fileExplorer" class="file-explorer">
        <div class="breadcrumb" id="breadcrumb">
            <div class="breadcrumb-item" data-id="-11">æ ¹ç›®å½•</div>
        </div>
        <div class="button-row">
            <button id="getFilesBtn">åˆ·æ–°æ–‡ä»¶åˆ—è¡¨</button>
            <button id="backToParentBtn" disabled>è¿”å›ä¸Šä¸€çº§</button>
        </div>
        <div id="downloadStatus" class="download-status"></div>
        <div id="fileList" class="file-list">
            <div class="loading">æ­£åœ¨åŠ è½½æ–‡ä»¶åˆ—è¡¨</div>
        </div>
    </div>
    <script>
        // å…¨å±€å˜é‡
        let userCookies = null;
        let userId = "default_user";  // ä½¿ç”¨é»˜è®¤ç”¨æˆ·ID
        let folderHistory = [];  // åˆå§‹ä¸ºç©ºï¼Œç­‰æœåŠ¡å™¨è¿”å›é»˜è®¤IDåå†è®¾ç½®
        let currentFolderId = '';  // åˆå§‹ä¸ºç©ºï¼ŒæœåŠ¡å™¨ä¼šè¿”å›é»˜è®¤å€¼
        let captchaData = null;  // å­˜å‚¨éªŒè¯ç ç›¸å…³æ•°æ®
        let allSessions = [];    // ä¿å­˜æ‰€æœ‰ä¼šè¯ä¿¡æ¯
        let defaultFolderId = ''; // ç¯å¢ƒå˜é‡ä¸­è®¾ç½®çš„é»˜è®¤æ–‡ä»¶å¤¹ID
        let rootFolderId = '-11'; // æ ¹ç›®å½•ID
        let isDefaultFolder = true; // å½“å‰æ˜¯å¦åœ¨é»˜è®¤æ–‡ä»¶å¤¹ä¸­
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½æ–‡ä»¶åˆ—è¡¨
        document.addEventListener('DOMContentLoaded', function() {
            console.log(`é¡µé¢åŠ è½½ï¼Œå‡†å¤‡åˆå§‹åŒ–...`);
            // é¦–å…ˆè·å–é…ç½®ä¿¡æ¯ï¼Œç„¶ååˆå§‹åŒ–
            getConfig();
            
            // éªŒè¯ç ç›¸å…³äº‹ä»¶
            document.getElementById('submitCaptchaBtn').addEventListener('click', submitCaptcha);
            document.getElementById('cancelCaptchaBtn').addEventListener('click', hideCaptchaModal);
            document.getElementById('refreshCaptchaBtn').addEventListener('click', refreshCaptcha);
            
            // æ–‡ä»¶æµè§ˆç›¸å…³äº‹ä»¶
            document.getElementById('getFilesBtn').addEventListener('click', function() {
                console.log(`æ‰‹åŠ¨åˆ·æ–°æ–‡ä»¶åˆ—è¡¨ï¼Œå½“å‰æ–‡ä»¶å¤¹ID: ${currentFolderId}`);
                // å¦‚æœå½“å‰æ–‡ä»¶å¤¹IDä¸ºç©ºï¼Œæˆ–è€…å¼ºåˆ¶åˆ·æ–°åˆ°é»˜è®¤ç›®å½•
                if (!currentFolderId || !isAllowedFolder(currentFolderId)) {
                    refreshToDefaultFolder();
                } else {
                    getFileList(currentFolderId);
                }
            });
            document.getElementById('backToParentBtn').addEventListener('click', function() {
                if (folderHistory.length > 1) {
                    // ç§»é™¤å½“å‰æ–‡ä»¶å¤¹
                    folderHistory.pop();
                    // è·å–ä¸Šä¸€çº§æ–‡ä»¶å¤¹
                    const parentFolder = folderHistory[folderHistory.length - 1];
                    console.log(`è¿”å›ä¸Šä¸€çº§æ–‡ä»¶å¤¹ï¼ŒID: ${parentFolder.id}`);
                    getFileList(parentFolder.id);
                }
            });
        });
        
        // è·å–é…ç½®ä¿¡æ¯
        async function getConfig() {
            try {
                console.log(`è·å–æœåŠ¡å™¨é…ç½®ä¿¡æ¯...`);
                const response = await fetch('/api/config');
                const configData = await response.json();
                
                if (configData.status === 'success') {
                    defaultFolderId = configData.data.defaultFolderId;
                    rootFolderId = configData.data.rootFolderId;
                    console.log(`è·å–åˆ°é…ç½®ä¿¡æ¯ï¼šé»˜è®¤æ–‡ä»¶å¤¹=${defaultFolderId}, æ ¹ç›®å½•=${rootFolderId}`);
                    
                    // åˆå§‹åŒ–é¡µé¢
                    initDefaultFolder();
                } else {
                    console.error('è·å–é…ç½®å¤±è´¥:', configData);
                    // ä½¿ç”¨ç¡¬ç¼–ç å€¼ç»§ç»­
                    initDefaultFolder();
                }
            } catch (error) {
                console.error('è·å–é…ç½®å‡ºé”™:', error);
                // ä½¿ç”¨ç¡¬ç¼–ç å€¼ç»§ç»­
                initDefaultFolder();
            }
        }
        
        // æ£€æŸ¥æ˜¯å¦å…è®¸è®¿é—®çš„æ–‡ä»¶å¤¹
        function isAllowedFolder(folderId) {
            // å¦‚æœæ˜¯é»˜è®¤æ–‡ä»¶å¤¹æˆ–è€…é»˜è®¤æ–‡ä»¶å¤¹çš„å­æ–‡ä»¶å¤¹(åœ¨å†å²è®°å½•ä¸­)
            if (folderId === defaultFolderId || folderHistory.some(f => f.id === defaultFolderId)) {
                return true;
            }
            // å¦‚æœé»˜è®¤æ–‡ä»¶å¤¹æ˜¯æ ¹ç›®å½•ï¼Œåˆ™å…è®¸è®¿é—®æ‰€æœ‰æ–‡ä»¶å¤¹
            if (defaultFolderId === rootFolderId) {
                return true;
            }
            // å…¶ä»–æƒ…å†µä¸å…è®¸è®¿é—®
            return false;
        }
        
        // å¼ºåˆ¶åˆ·æ–°åˆ°é»˜è®¤æ–‡ä»¶å¤¹
        function refreshToDefaultFolder() {
            console.log(`å¼ºåˆ¶åˆ·æ–°åˆ°é»˜è®¤æ–‡ä»¶å¤¹: ${defaultFolderId}`);
            currentFolderId = defaultFolderId;
            folderHistory = [{id: defaultFolderId, name: 'æ ¹ç›®å½•'}];
            isDefaultFolder = true;
            getFileList(defaultFolderId);
        }
        
        // æ˜¾ç¤ºéªŒè¯ç å¼¹çª—
        function showCaptchaModal(captchaImageBase64, data) {
            captchaData = data;
            if (!captchaImageBase64) {
                alert('éªŒè¯ç å›¾ç‰‡æ•°æ®ä¸ºç©ºï¼');
                return;
            }
            document.getElementById('captchaImage').src = 'data:image/png;base64,' + captchaImageBase64;
            document.getElementById('captchaInput').value = '';
            document.getElementById('captchaModal').classList.remove('hidden');
        }
        
        // éšè—éªŒè¯ç å¼¹çª—
        function hideCaptchaModal() {
            document.getElementById('captchaModal').classList.add('hidden');
        }
        
        // åˆå§‹åŒ–é»˜è®¤æ–‡ä»¶å¤¹
        async function initDefaultFolder() {
            try {
                console.log(`æ­£åœ¨åˆå§‹åŒ–é»˜è®¤æ–‡ä»¶å¤¹ï¼ŒID: ${defaultFolderId}...`);
                
                // ç›´æ¥ä½¿ç”¨é…ç½®ä¸­çš„é»˜è®¤æ–‡ä»¶å¤¹ID
                if (defaultFolderId) {
                    currentFolderId = defaultFolderId;
                    folderHistory = [{id: defaultFolderId, name: 'æ ¹ç›®å½•'}];
                    isDefaultFolder = true;
                    
                    // è·å–æ–‡ä»¶åˆ—è¡¨
                    getFileList(defaultFolderId);
                    return;
                }
                
                // å¦‚æœæ²¡æœ‰è·å–åˆ°é…ç½®ï¼Œä½¿ç”¨APIè·å–é»˜è®¤æ–‡ä»¶å¤¹
                const response = await fetch('/api/files', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: userId
                    })
                });
                
                const data = await response.json();
                console.log('æœåŠ¡å™¨é»˜è®¤æ–‡ä»¶å¤¹å“åº”:', data);
                
                if (data.status === 'success') {
                    // æœåŠ¡å™¨è¿”å›çš„é»˜è®¤æ–‡ä»¶å¤¹ID
                    const serverId = data.data.folderId;
                    console.log(`æœåŠ¡å™¨è¿”å›çš„é»˜è®¤æ–‡ä»¶å¤¹ID: ${serverId}`);
                    
                    // è®¾ç½®å½“å‰æ–‡ä»¶å¤¹ID
                    currentFolderId = serverId;
                    defaultFolderId = serverId; // åŒæ—¶è®¾ç½®ä¸ºé»˜è®¤æ–‡ä»¶å¤¹
                    
                    // åˆå§‹åŒ–æ–‡ä»¶å¤¹å†å²
                    folderHistory = [{id: serverId, name: 'æ ¹ç›®å½•'}];
                    isDefaultFolder = true;
                    
                    // ç°åœ¨ä½¿ç”¨æ­£å¸¸çš„æ–‡ä»¶åˆ—è¡¨è·å–é€»è¾‘
                    console.log(`ä½¿ç”¨è·å–åˆ°çš„é»˜è®¤IDåˆ·æ–°æ–‡ä»¶åˆ—è¡¨: ${currentFolderId}`);
                    getFileList(currentFolderId);
                } else if (data.status === 'need_captcha') {
                    // éœ€è¦éªŒè¯ç 
                    if (data.data && data.data.captcha_image) {
                        showCaptchaModal(data.data.captcha_image, data.data);
                    }
                } else {
                    // å¤±è´¥ï¼Œå°è¯•å¼ºåˆ¶ç™»å½•
                    await performLogin(true);
                }
            } catch (error) {
                console.error('åˆå§‹åŒ–é»˜è®¤æ–‡ä»¶å¤¹å¤±è´¥ï¼Œå°è¯•å¼ºåˆ¶ç™»å½•', error);
                await performLogin(true);
            }
        }
        
        // æ‰§è¡Œç™»å½•æ“ä½œ
        async function performLogin(forceNewLogin = false) {
            try {
                // å¦‚æœéœ€è¦å¼ºåˆ¶æ–°ç™»å½•ï¼Œä½¿ç”¨ä¸åŒçš„API
                const url = forceNewLogin ? '/api/login' : '/api/auto-login';
                const method = forceNewLogin ? 'POST' : 'GET';
                const body = forceNewLogin ? JSON.stringify({
                    username: '',  // ä½¿ç”¨é»˜è®¤è´¦å·
                    password: '',
                    remember: true
                }) : null;
                
                const response = await fetch(url, {
                    method: method,
                    headers: forceNewLogin ? {
                        'Content-Type': 'application/json'
                    } : {},
                    body: body
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    // ä¿å­˜cookieså’ŒuserId
                    userCookies = data.data.cookies;
                    userId = data.data.userId || 'default_user';
                    
                    // é‡æ–°åˆå§‹åŒ–é»˜è®¤æ–‡ä»¶å¤¹
                    initDefaultFolder();
                } else if (data.status === 'need_captcha') {
                    // éœ€è¦éªŒè¯ç 
                    
                    // æ˜¾ç¤ºéªŒè¯ç å¼¹çª—
                    if (data.data && data.data.captcha_image) {
                        showCaptchaModal(data.data.captcha_image, data.data);
                    } else {
                        console.error('éªŒè¯ç æ•°æ®ä¸å®Œæ•´');
                        alert('è·å–éªŒè¯ç å¤±è´¥: éªŒè¯ç å›¾ç‰‡æ•°æ®ä¸å®Œæ•´');
                        document.getElementById('fileList').innerHTML = `<div style="padding: 20px; text-align: center; color: red;">è·å–éªŒè¯ç å¤±è´¥ï¼šéªŒè¯ç å›¾ç‰‡æ•°æ®ä¸å®Œæ•´</div>`;
                    }
                } else {
                    document.getElementById('fileList').innerHTML = `<div style="padding: 20px; text-align: center; color: red;">ç™»å½•å¤±è´¥ï¼š${data.message || 'æœªçŸ¥é”™è¯¯'}</div>`;
                }
            } catch (error) {
                console.error('ç™»å½•è¯·æ±‚å‡ºé”™');
                document.getElementById('fileList').innerHTML = `<div style="padding: 20px; text-align: center; color: red;">ç™»å½•è¯·æ±‚å‡ºé”™: ${error.message}</div>`;
            }
        }

        // æäº¤éªŒè¯ç 
        async function submitCaptcha() {
            const validateCode = document.getElementById('captchaInput').value.trim();
            
            if (!validateCode) {
                alert('è¯·è¾“å…¥éªŒè¯ç ');
                return;
            }
            
            try {
                const response = await fetch('/api/captcha/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        validateCode: validateCode,
                        captchaToken: captchaData.captcha_token,
                        lt: captchaData.lt,
                        reqId: captchaData.req_id,
                        appId: captchaData.app_id,
                        remember: true
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    // ç™»å½•æˆåŠŸï¼Œéšè—éªŒè¯ç å¼¹çª—
                    hideCaptchaModal();
                    
                    // ä¿å­˜cookieså’ŒuserId
                    userCookies = data.data.cookies;
                    userId = data.data.userId;
                    
                    // é‡æ–°åˆå§‹åŒ–é»˜è®¤æ–‡ä»¶å¤¹ï¼Œä¸é€šå¸¸çš„åˆ·æ–°é€»è¾‘ä¿æŒä¸€è‡´
                    initDefaultFolder();
                } else if (data.status === 'need_captcha') {
                    // éªŒè¯ç é”™è¯¯ï¼Œæ˜¾ç¤ºæ–°çš„éªŒè¯ç 
                    alert('éªŒè¯ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥');
                    if (data.data && data.data.captcha_image) {
                        showCaptchaModal(data.data.captcha_image, data.data);
                    }
                } else {
                    alert('ç™»å½•å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                alert('éªŒè¯ç æäº¤å¤±è´¥: ' + error.message);
            }
        }
        
        // åˆ·æ–°éªŒè¯ç 
        async function refreshCaptcha() {
            document.getElementById('captchaStatus').style.display = 'block';
            document.getElementById('captchaStatus').innerText = 'æ­£åœ¨åˆ·æ–°éªŒè¯ç ...';
            document.getElementById('captchaImage').style.display = 'none';
            
            try {
                const response = await fetch('/api/refresh', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: userId
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'need_captcha' && data.data && data.data.captcha_image) {
                    // æ›´æ–°éªŒè¯ç å›¾ç‰‡
                    captchaData = data.data;
                    document.getElementById('captchaImage').src = 'data:image/png;base64,' + data.data.captcha_image;
                    document.getElementById('captchaInput').value = '';
                } else {
                    document.getElementById('captchaStatus').innerText = 'åˆ·æ–°éªŒè¯ç å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯');
                    document.getElementById('captchaStatus').style.color = 'red';
                }
            } catch (error) {
                console.error('åˆ·æ–°éªŒè¯ç å¤±è´¥');
                document.getElementById('captchaStatus').innerText = 'åˆ·æ–°éªŒè¯ç å¤±è´¥: ' + error.message;
                document.getElementById('captchaStatus').style.color = 'red';
            }
        }
        
        // å¤„ç†æ–‡ä»¶åˆ—è¡¨æ•°æ®
        function handleFileListData(data) {
            const fileList = document.getElementById('fileList');
                    
            // æ›´æ–°é¢åŒ…å±‘å¯¼èˆª
            updateBreadcrumb();

            // æ¸…ç©ºæ–‡ä»¶åˆ—è¡¨
            fileList.innerHTML = '';
            
            // æ·»åŠ æ–‡ä»¶å¤¹
            data.data.folders.forEach(folder => {
                const folderItem = document.createElement('div');
                folderItem.className = 'folder-item';
                folderItem.innerHTML = `
                    <span class="folder-icon">ğŸ“</span>
                    <span>${folder.name}</span>
                `;
                folderItem.addEventListener('click', function() {
                    // æ·»åŠ åˆ°å†å²è®°å½•
                    if (!folderHistory.find(f => f.id === folder.id)) {
                        folderHistory.push({id: folder.id, name: folder.name});
                    }
                    getFileList(folder.id);
                });
                fileList.appendChild(folderItem);
            });
            
            // æ·»åŠ æ–‡ä»¶
            data.data.files.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.dataset.id = file.id;
                fileItem.innerHTML = `
                    <span class="file-icon">ğŸ“„</span>
                    <span>${file.name}</span>
                `;
                fileItem.addEventListener('click', function() {
                    downloadFile(file.id, file.name);
                });
                fileList.appendChild(fileItem);
            });

            // å¦‚æœæ²¡æœ‰æ–‡ä»¶å’Œæ–‡ä»¶å¤¹
            if (data.data.folders.length === 0 && data.data.files.length === 0) {
                fileList.innerHTML = '<div style="padding: 20px; text-align: center;">æ­¤æ–‡ä»¶å¤¹ä¸ºç©º</div>';
            }
        }

        // è·å–æ–‡ä»¶åˆ—è¡¨
        async function getFileList(folderId) {
            // é¦–å…ˆæ£€æŸ¥æ˜¯å¦å…è®¸è®¿é—®è¯¥æ–‡ä»¶å¤¹
            if (!isAllowedFolder(folderId)) {
                console.warn(`ä¸å…è®¸è®¿é—®æ–‡ä»¶å¤¹ ${folderId}ï¼Œå¼ºåˆ¶ä½¿ç”¨é»˜è®¤æ–‡ä»¶å¤¹ ${defaultFolderId}`);
                refreshToDefaultFolder();
                return;
            }
            
            console.log(`æ­£åœ¨è·å–æ–‡ä»¶å¤¹ID: ${folderId} çš„å†…å®¹`);
            
            const fileList = document.getElementById('fileList');
            const backToParentBtn = document.getElementById('backToParentBtn');
            
            // ç¦ç”¨æˆ–å¯ç”¨è¿”å›æŒ‰é’® - åœ¨é»˜è®¤æ–‡ä»¶å¤¹ä¸­ç¦ç”¨è¿”å›æŒ‰é’®
            backToParentBtn.disabled = folderHistory.length <= 1 || folderId === defaultFolderId;
            
            // æ˜¾ç¤ºåŠ è½½ä¸­
            fileList.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½æ–‡ä»¶åˆ—è¡¨</div>';
            
            try {
                const requestBody = {
                    folderId: folderId,
                    userId: userId
                };
                
                console.log(`å‘é€è¯·æ±‚å‚æ•°: `, requestBody);
                
                const response = await fetch('/api/files', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const data = await response.json();
                console.log(`APIå“åº”:`, data);
                
                if (data.status === 'success') {
                    // æ›´æ–°å½“å‰æ–‡ä»¶å¤¹ID
                    currentFolderId = folderId;
                    console.log(`å½“å‰æ–‡ä»¶å¤¹IDå·²æ›´æ–°ä¸º: ${currentFolderId}`);
                    
                    // å¦‚æœå½“å‰æ–‡ä»¶å¤¹æ˜¯é»˜è®¤æ–‡ä»¶å¤¹ï¼Œæ ‡è®°çŠ¶æ€
                    isDefaultFolder = (currentFolderId === defaultFolderId);
                    
                    // å¤„ç†æ–‡ä»¶åˆ—è¡¨æ•°æ®
                    handleFileListData(data);
                } else if (data.status === 'need_refresh') {
                    // è‡ªåŠ¨æ›´æ–°cookieså¹¶é‡æ–°è·å–æ–‡ä»¶åˆ—è¡¨
                    fileList.innerHTML = '<div style="padding: 20px; text-align: center; color: orange;">ç™»å½•å·²è‡ªåŠ¨åˆ·æ–°ï¼Œæ­£åœ¨é‡æ–°è·å–æ–‡ä»¶åˆ—è¡¨...</div>';
                    
                    // æ›´æ–°cookies
                    userCookies = data.data.cookies;
                    
                    // å»¶è¿Ÿä¸€ä¸‹å†åˆ·æ–°ï¼Œé¿å…è¯·æ±‚è¿‡äºé¢‘ç¹
                    setTimeout(() => {
                        getFileList(folderId);
                    }, 1000);
                } else if (data.status === 'need_captcha') {
                    // éœ€è¦éªŒè¯ç 
                    fileList.innerHTML = '<div style="padding: 20px; text-align: center; color: orange;">éœ€è¦è¾“å…¥éªŒè¯ç </div>';
                    
                    // æ˜¾ç¤ºéªŒè¯ç å¼¹çª—
                    if (data.data && data.data.captcha_image) {
                        showCaptchaModal(data.data.captcha_image, data.data);
                    }
                } else {
                    // å¦‚æœè·å–å¤±è´¥ï¼Œå°è¯•é‡æ–°ç™»å½•å¹¶åˆ·æ–°åˆ°é»˜è®¤æ–‡ä»¶å¤¹
                    fileList.innerHTML = `<div style="padding: 20px; text-align: center; color: red;">è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥ï¼š${data.message || 'æœªçŸ¥é”™è¯¯'}</div>`;
                    
                    // æ·»åŠ åˆ·æ–°åˆ°é»˜è®¤æ–‡ä»¶å¤¹çš„æŒ‰é’®
                    const refreshBtn = document.createElement('button');
                    refreshBtn.textContent = 'åˆ·æ–°åˆ°é»˜è®¤æ–‡ä»¶å¤¹';
                    refreshBtn.style.marginTop = '10px';
                    refreshBtn.onclick = refreshToDefaultFolder;
                    fileList.appendChild(refreshBtn);
                    
                    // å°è¯•é‡æ–°ç™»å½•
                    setTimeout(performLogin, 1000);
                }
            } catch (error) {
                fileList.innerHTML = `<div style="padding: 20px; text-align: center; color: red;">è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥ï¼š${error.message}</div>`;
                
                // æ·»åŠ åˆ·æ–°åˆ°é»˜è®¤æ–‡ä»¶å¤¹çš„æŒ‰é’®
                const refreshBtn = document.createElement('button');
                refreshBtn.textContent = 'åˆ·æ–°åˆ°é»˜è®¤æ–‡ä»¶å¤¹';
                refreshBtn.style.marginTop = '10px';
                refreshBtn.onclick = refreshToDefaultFolder;
                fileList.appendChild(refreshBtn);
            }
        }

        function updateBreadcrumb() {
            const breadcrumb = document.getElementById('breadcrumb');
            breadcrumb.innerHTML = '';
            
            folderHistory.forEach((folder, index) => {
                const item = document.createElement('div');
                item.className = 'breadcrumb-item';
                item.textContent = folder.name;
                item.dataset.id = folder.id;
                
                item.addEventListener('click', function() {
                    // ç‚¹å‡»æ—¶æˆªæ–­å†å²åˆ°æ­¤ä½ç½®
                    folderHistory = folderHistory.slice(0, index + 1);
                    getFileList(folder.id);
                });
                
                breadcrumb.appendChild(item);
            });
        }

        // ä¸‹è½½æ–‡ä»¶å‡½æ•°
        async function downloadFile(fileId, fileName) {
            const downloadStatus = document.getElementById('downloadStatus');
            downloadStatus.className = 'download-status loading';
            downloadStatus.innerHTML = `æ­£åœ¨è·å–æ–‡ä»¶ "${fileName}" çš„ä¸‹è½½é“¾æ¥...`;
            
            try {
                const response = await fetch(`/api/download?fileId=${fileId}&userId=${userId}`);
                const data = await response.json();
                
                if (data.status === 'success' && data.data && data.data.url) {
                    // æˆåŠŸè·å–ä¸‹è½½é“¾æ¥
                    downloadStatus.className = 'download-status success';
                    downloadStatus.innerHTML = `
                        <div>å·²è·å–æ–‡ä»¶ "${data.data.fileName}" çš„ä¸‹è½½é“¾æ¥</div>
                        <a href="${data.data.url}" class="download-link" target="_blank" download="${data.data.fileName}">ç‚¹å‡»ä¸‹è½½æ–‡ä»¶</a>
                        <div style="margin-top: 5px; font-size: 12px;">(æˆ–è€…å³é”®ç‚¹å‡»é“¾æ¥ï¼Œé€‰æ‹©"å¦å­˜ä¸º")</div>
                    `;
                    
                    // è‡ªåŠ¨æ‰“å¼€ä¸‹è½½é“¾æ¥
                    window.open(data.data.url, '_blank');
                } else {
                    // è·å–ä¸‹è½½é“¾æ¥å¤±è´¥
                    downloadStatus.className = 'download-status error';
                    downloadStatus.innerHTML = `è·å–ä¸‹è½½é“¾æ¥å¤±è´¥: ${data.message || 'æœªçŸ¥é”™è¯¯'}`;
                }
            } catch (error) {
                console.error('ä¸‹è½½æ–‡ä»¶å‡ºé”™');
                downloadStatus.className = 'download-status error';
                downloadStatus.innerHTML = `ä¸‹è½½æ–‡ä»¶å‡ºé”™: ${error.message}`;
            }
        }
    </script>
    
</body>
</html>